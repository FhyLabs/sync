var SyncLib=function(){"use strict";async function t(t,e={}){try{const s=await fetch(t,{mode:"cors",...e});if(!s.ok)throw new Error(`HTTP ${s.status} ${s.statusText}`);return(s.headers.get("content-type")||"").toLowerCase().includes("application/json")?await s.json():await s.text()}catch(t){throw t}}const e=new class{constructor(){this.plugins=[],this.hooks={}}use(t){if(!t)return;this.plugins.push(t);const e=["sync:onload","sync:beforeUpdate","sync:afterUpdate","sync:error","sync:connect","sync:disconnect"];for(const s of e)"function"==typeof t[s]&&(this.hooks[s]=this.hooks[s]||[],this.hooks[s].push(t[s].bind(t)))}on(t,e){this.hooks[t]=this.hooks[t]||[],this.hooks[t].push(e)}trigger(t,e){(this.hooks[t]||[]).forEach(s=>{try{s(e)}catch(e){console.error(`[SyncLib Plugin Error][${t}]`,e)}})}};class s{constructor(t){this.el=t,this.rawEndpoint=t.dataset.endpoint,this.endpoint=((t,e)=>{try{return/^https?:\/\//i.test(e)?e:new URL(e,t).toString()}catch(t){return e}})(window.location.origin,this.rawEndpoint),this.format=(t.dataset.format||"auto").toLowerCase(),this.renderFn=t.dataset.render||null,this.interval=parseInt(t.dataset.interval||"5000",10),this.mode=(t.dataset.mode||"auto").toLowerCase(),this.diff="true"===t.dataset.diff,this.cache="true"===t.dataset.cache,this.started=!1,this.connection=null,this.timer=null,this.init()}async init(){e.trigger("sync:onload",{element:this.el,endpoint:this.endpoint}),this.start()}async start(){if(!this.started)switch(this.started=!0,"auto"===this.mode&&(this.endpoint.startsWith("ws")?this.mode="websocket":this.endpoint.endsWith(".json")?this.mode="polling":this.endpoint.includes("/stream")?this.mode="sse":this.mode="polling"),e.trigger("sync:connect",{element:this.el,mode:this.mode}),this.mode){case"polling":this.startPolling();break;case"sse":this.startSSE();break;case"websocket":this.startWebSocket();break;case"event":this.startEvent();break;case"local":this.loadOnce();break;default:console.warn("Unknown sync mode:",this.mode)}}async startPolling(){const s=async()=>{e.trigger("sync:beforeUpdate",{element:this.el,endpoint:this.endpoint});try{const e=await t(this.endpoint);this._onData(e)}catch(t){this._onError(t)}};await s(),this.timer=setInterval(s,this.interval)}startSSE(){try{const t=new EventSource(this.endpoint);t.onmessage=t=>{try{const e=JSON.parse(t.data);this._onData(e)}catch{this._onData(t.data)}},t.onerror=t=>this._onError(t),this.connection=t}catch(t){this._onError(t)}}startWebSocket(){try{const t=new WebSocket(this.endpoint);t.onopen=()=>e.trigger("sync:connect",{element:this.el,mode:"websocket"}),t.onmessage=t=>{try{const e=JSON.parse(t.data);this._onData(e)}catch{this._onData(t.data)}},t.onerror=t=>this._onError(t),t.onclose=()=>e.trigger("sync:disconnect",{element:this.el}),this.connection=t}catch(t){this._onError(t)}}startEvent(){this.el.addEventListener("sync:trigger",async()=>{e.trigger("sync:beforeUpdate",{element:this.el,endpoint:this.endpoint});try{const e=await t(this.endpoint);this._onData(e)}catch(t){this._onError(t)}})}async loadOnce(){try{const e=await t(this.endpoint);this._onData(e)}catch(t){this._onError(t)}}_onData(t){try{e.trigger("sync:beforeUpdate",{element:this.el,data:t}),function(t,e,s,{diff:n=!1}={}){if(s&&"function"==typeof window[s]){const o=window[s](e);n?t.__lastHTML!==o&&(t.innerHTML=o,t.__lastHTML=o):(t.innerHTML=o,t.__lastHTML=o)}else if("object"==typeof e){const s=`<pre>${JSON.stringify(e,null,2)}</pre>`;n?t.__lastHTML!==s&&(t.innerHTML=s,t.__lastHTML=s):(t.innerHTML=s,t.__lastHTML=s)}else t.textContent=e}(this.el,t,this.renderFn,{diff:this.diff}),e.trigger("sync:afterUpdate",{element:this.el,data:t})}catch(t){this._onError(t)}}_onError(t){e.trigger("sync:error",{element:this.el,error:t})}stop(){this.timer&&clearInterval(this.timer),this.connection&&("sse"===this.mode&&this.connection.close(),"websocket"===this.mode&&this.connection.close()),this.started=!1,e.trigger("sync:disconnect",{element:this.el,endpoint:this.endpoint})}}const n=new class{constructor(){this.instances=[],this.selector='[sync="true"]'}start(t=null){const n=t||this.selector;return document.querySelectorAll(n).forEach(t=>{if(t.__syncInstance)return;const e=new s(t);t.__syncInstance=e,this.instances.push(e)}),e.trigger("sync:manager:start",{count:this.instances.length}),this.instances}stop(){this.instances.forEach(t=>t.stop()),this.instances=[],e.trigger("sync:manager:stop",{})}},o={start:t=>n.start(t),stop:()=>n.stop(),on:(t,s)=>e.on(t,s),use:t=>e.use(t),_manager:n};return window.SyncLib=o,document.addEventListener("DOMContentLoaded",()=>o.start()),o}();
